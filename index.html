<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Ward Live Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f4f6f9; }
        .table-responsive { max-height: 85vh; overflow: auto; position: relative; background: white; }
        thead th { position: sticky; top: 0; background: #2c3e50; color: white; z-index: 10; white-space: nowrap; border: 1px solid #dee2e6; }
        
        /* Cell Styling - Show borders on all cells */
        table { border-collapse: collapse; }
        td { border: 1px solid #dee2e6; padding: 0; height: 35px; min-width: 120px; }
        input.cell-input, select.cell-input { 
            width: 100%; 
            height: 100%; 
            border: none; 
            background: transparent; 
            padding: 5px; 
            min-width: 120px; 
            box-sizing: border-box; 
        }
        input.cell-input:focus, select.cell-input:focus { outline: 2px solid #3498db; background: #fff; }
        
        /* Live Presence Indicators */
        .being-edited { border: 2px solid #e74c3c !important; background-color: #fadbd8 !important; }
        
        /* Tab Styling */
        .nav-tabs .nav-link { cursor: pointer; color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; }
        
        /* Card View Styling */
        .card-view { display: none; padding: 20px; max-height: 85vh; overflow-y: auto; }
        .card-view.active { display: block; }
        
        /* Filter Controls */
        .filter-controls {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .filter-controls h6 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-weight: bold;
        }
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
        }
        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .filter-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-apply-filter {
            background: #3498db;
            color: white;
        }
        .btn-apply-filter:hover {
            background: #2980b9;
        }
        .btn-clear-filter {
            background: #95a5a6;
            color: white;
        }
        .btn-clear-filter:hover {
            background: #7f8c8d;
        }
        .results-count {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 10px;
        }
        .btn-add-patient {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            margin-left: auto;
        }
        .btn-add-patient:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: scale(1.05);
        }
        
        /* Queue indicator styles */
        .queue-indicator {
            background: linear-gradient(135deg, #fff5e6, #ffe4b3);
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #f39c12;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .queue-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .queue-next {
            font-weight: 700;
            font-size: 1.1em;
            color: #e74c3c;
            margin-left: 5px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5em;
        }
        .btn-close-modal {
            background: none;
            border: none;
            font-size: 2em;
            color: #95a5a6;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }
        .btn-close-modal:hover {
            color: #e74c3c;
        }
        .modal-body {
            display: grid;
            gap: 15px;
        }
        .modal-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .modal-field label {
            font-weight: 600;
            color: #34495e;
            font-size: 0.9em;
        }
        .modal-field input,
        .modal-field select {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .modal-field input:focus,
        .modal-field select:focus {
            outline: none;
            border-color: #3498db;
        }
        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid #ecf0f1;
        }
        .btn-submit-patient {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            font-size: 1em;
            transition: all 0.3s;
        }
        .btn-submit-patient:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
        }
        .btn-cancel-modal {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            background: #95a5a6;
            color: white;
            font-size: 1em;
            transition: all 0.3s;
        }
        .btn-cancel-modal:hover {
            background: #7f8c8d;
        }
        .btn-delete-card {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .btn-delete-card:hover {
            background: #c0392b;
            transform: scale(1.05);
        }
        
        /* Color picker button styles */
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.85em;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #ff1493 0%, #c71585 100%);
            transform: translateY(-1px);
        }
        .btn-warning {
            background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);
            color: #333;
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #ffb800 0%, #ff9500 100%);
            transform: translateY(-1px);
        }
        .btn-info {
            background: linear-gradient(135deg, #00bfff 0%, #1e90ff 100%);
            color: white;
        }
        .btn-info:hover {
            background: linear-gradient(135deg, #1e90ff 0%, #0066cc 100%);
            transform: translateY(-1px);
        }
        .btn-success {
            background: linear-gradient(135deg, #66cdaa 0%, #3cb371 100%);
            color: white;
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #3cb371 0%, #2e8b57 100%);
            transform: translateY(-1px);
        }
        
        .patient-card { 
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
            padding: 14px 18px; 
            margin-bottom: 14px;
            border-left: 5px solid #3498db;
            font-size: 0.95em;
            line-height: 1.7;
            position: relative;
            transition: all 0.2s ease;
        }
        .patient-card:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        /* Expand button */
        .btn-expand-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .btn-expand-card:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: scale(1.15);
        }
        
        /* Expanded details section */
        .card-expanded-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #bdc3c7;
            animation: slideDown 0.3s ease;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }
        .expanded-header {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.05em;
            text-align: center;
            background: linear-gradient(135deg, #e8f4f8, #dce8f0);
            padding: 8px;
            border-radius: 6px;
        }
        .expanded-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        .expanded-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .expanded-field label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
        }
        .expanded-field input, .expanded-field select {
            width: 100%;
            padding: 6px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .expanded-field input:focus, .expanded-field select:focus {
            border-color: #3498db;
            outline: none;
        }
        
        /* Staff select dropdown styling */
        .staff-select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .staff-select option {
            color: #333;
            background: white;
            text-shadow: none;
        }
        
        /* Status color coding */
        .patient-card.status-discharge { border-left-color: #e74c3c; }
        .patient-card.status-active { border-left-color: #27ae60; }
        .patient-card.status-critical { border-left-color: #e74c3c; }
        .patient-card.status-pending { border-left-color: #f39c12; }
        
        .card-compact-line {
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .card-compact-line.first-line {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
            position: relative;
            padding-right: 0;
        }
        .card-compact-line.location-line {
            background: rgba(52, 152, 219, 0.12);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 0 -4px 8px -4px;
            font-size: 1.05em;
            font-weight: 500;
        }
        .card-compact-line.diagnosis-line {
            color: #2c3e50;
            padding-left: 8px;
            background: rgba(231, 76, 60, 0.08);
            margin-left: -4px;
            margin-right: -4px;
            padding: 8px 12px;
            border-radius: 6px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 1em;
            font-weight: 500;
        }
        .card-compact-line.admit-line {
            color: #34495e;
            font-size: 0.95em;
            font-weight: 500;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 2px solid #ecf0f1;
        }
        
        .card-inline-field {
            display: inline-block;
        }
        .card-inline-field input,
        .card-inline-field select {
            display: inline-block;
            border: 1px solid #ddd;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.95em;
            background: white;
            transition: all 0.2s;
            width: auto;
            min-width: 40px;
            max-width: 100%;
        }
        .card-inline-field input:focus,
        .card-inline-field select:focus {
            outline: none;
            border-color: #3498db;
            background: #e3f2fd;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        .card-inline-field input.being-edited,
        .card-inline-field select.being-edited { 
            border-color: #e74c3c; 
            background-color: #fff5f5;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .card-inline-field.wide input {
            min-width: 100px;
            font-size: 1em;
        }
        .card-inline-field.narrow input {
            min-width: 35px;
            max-width: 60px;
            text-align: center;
        }
        
        /* Badge styles for staff and status */
        .badge-staff {
            color: white;
            padding: 5px 14px;
            border-radius: 20px;
            font-weight: 700;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            font-size: 1em;
        }
        .badge-staff input,
        .badge-staff select {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            font-weight: 700 !important;
        }
        .badge-staff input:focus,
        .badge-staff select:focus {
            background: rgba(255, 255, 255, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
        }
        .badge-staff input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .badge-status {
            padding: 5px 14px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
            font-size: 1em;
        }
        .badge-status input,
        .badge-status select {
            font-weight: 600 !important;
        }
        .badge-status select.status-select {
            background: transparent !important;
            border: none !important;
            color: inherit !important;
            padding: 0 !important;
            font-weight: 700 !important;
            cursor: pointer;
            outline: none;
        }
        .badge-status select.status-select option {
            background: white;
            color: #2c3e50;
            font-weight: 600;
        }
        .badge-status.discharge {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
        }
        .badge-status.discharge input,
        .badge-status.discharge select {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
        .badge-status.discharge input:focus {
            background: rgba(255, 255, 255, 0.3) !important;
        }
        .badge-status.active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }
        .badge-status.active input,
        .badge-status.active select {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
        .badge-status.active select.status-select {
            background: transparent !important;
            border: none !important;
        }
        .badge-status.discharge select.status-select {
            background: transparent !important;
            border: none !important;
        }
        .badge-status.active input:focus {
            background: rgba(255, 255, 255, 0.3) !important;
        }
        .badge-status.default {
            background: #95a5a6;
            color: white;
            box-shadow: 0 2px 4px rgba(149, 165, 166, 0.3);
        }
        .badge-status.default input,
        .badge-status.default select {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
        }
        .badge-status.default input:focus {
            background: rgba(255, 255, 255, 0.3) !important;
        }
        .location-badge {
            background: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            color: #2c3e50;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            font-size: 1.05em;
        }
        .location-divider {
            color: #3498db;
            font-weight: bold;
            font-size: 1.3em;
            margin: 0 2px;
        }
        .bed-number {
            color: #e74c3c;
            font-weight: 900;
            font-size: 1.2em;
        }
        .bed-number input {
            color: #e74c3c !important;
            font-weight: 900 !important;
            font-size: 1.1em !important;
            text-align: center;
            background: #fff5f5 !important;
            border: 2px solid #e74c3c !important;
            cursor: pointer;
            padding: 4px 8px !important;
        }
        .bed-number input:hover {
            background: #ffe6e6 !important;
            border-color: #c0392b !important;
        }
        .bed-number input:focus {
            background: white !important;
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2) !important;
            border-color: #c0392b !important;
        }
        .bed-number input::placeholder {
            color: #e74c3c;
            opacity: 0.5;
        }
        .diagnosis-tag {
            flex-shrink: 0;
            font-size: 1.2em;
            margin-right: 6px;
        }
        .diagnosis-text {
            flex: 1;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }
        .card-inline-field.diagnosis-field {
            flex: 1;
            min-width: 150px;
            max-width: 100%;
        }
        .card-inline-field.diagnosis-field input {
            width: 100%;
            min-width: 150px;
            max-width: 100%;
        }
        .info-label {
            color: #7f8c8d;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Date input styling */
        input[type="date"] {
            cursor: pointer;
        }
        .view-toggle { 
            display: flex; 
            gap: 5px; 
            background: #e9ecef; 
            padding: 3px; 
            border-radius: 6px;
        }
        .view-toggle button { 
            border: none; 
            background: transparent; 
            padding: 6px 12px; 
            cursor: pointer; 
            border-radius: 4px;
            font-size: 0.9em;
        }
        .view-toggle button.active { background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        /* Simple Login Overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card p-4 shadow text-center" style="width:350px;">
        <h4 class="mb-3">üè• Ward Dashboard</h4>
        <p class="text-muted small">Enter your name to start editing</p>
        
        <div class="mb-3">
            <input type="text" id="guestName" class="form-control form-control-lg" placeholder="e.g. Nurse Joy, Dr. Strange">
        </div>
        <button class="btn btn-primary w-100 btn-lg" id="btnEnter">Enter Dashboard</button>
        <p id="loginError" class="text-danger mt-2 small"></p>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="d-flex justify-content-between align-items-center bg-white p-3 shadow-sm border-bottom">
        <div class="d-flex align-items-center gap-2">
            <h5 class="m-0 text-primary">üè• Live Ward</h5>
            <span class="badge bg-secondary" id="sheetNameDisplay">Loading...</span>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="view-toggle">
                <button id="btnTableView" class="active" onclick="switchView('table')">üìä Table</button>
                <button id="btnCardView" onclick="switchView('card')">üìã Cards</button>
            </div>
            <span class="text-muted small">üë§ <span id="userDisplay">Guest</span></span>
            <button class="btn btn-sm btn-outline-secondary" onclick="changeName()">Change Name</button>
            <button class="btn btn-sm btn-outline-primary" onclick="openColorSettings()">üé® ‡∏™‡∏µ</button>
        </div>
    </div>

    <ul class="nav nav-tabs px-3 pt-2 bg-white" id="sheetTabs">
        <li class="nav-item"><a class="nav-link disabled">Connecting...</a></li>
    </ul>

    <div class="table-responsive">
        <table class="table table-bordered table-sm mb-0 bg-white">
            <thead id="tableHead"></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="card-view" id="cardView">
        <div class="filter-controls">
            <h6>üîç ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
            <div class="filter-row">
                <div class="filter-group">
                    <label>‡∏ß‡∏≠‡∏£‡πå‡∏î</label>
                    <select id="filterWard" onchange="applyFilters()">
                        <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™</label>
                    <select id="filterStaff" onchange="applyFilters()">
                        <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Status</label>
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
                        <option value="active">Active</option>
                        <option value="discharge">Discharge</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á --</option>
                        <option value="bed-asc">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á (‡∏ô‡πâ‡∏≠‡∏¢ ‚Üí ‡∏°‡∏≤‡∏Å)</option>
                        <option value="bed-desc">‡πÄ‡∏ï‡∏µ‡∏¢‡∏á (‡∏°‡∏≤‡∏Å ‚Üí ‡∏ô‡πâ‡∏≠‡∏¢)</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn-apply-filter" onclick="applyFilters()">‚úì ‡∏Å‡∏£‡∏≠‡∏á</button>
                <button class="btn-clear-filter" onclick="clearFilters()">‚úï ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
                <button class="btn-add-patient" onclick="openAddPatientModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
                <div class="queue-indicator" id="queueIndicator" style="display: inline-block; margin-left: 15px;">
                    <span class="queue-label">üîÑ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</span>
                    <span class="queue-next" id="queueNext"></span>
                </div>
            </div>
            <div class="results-count" id="resultsCount"></div>
        </div>
        <div id="cardContainer">
            <!-- Cards will be rendered here -->
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="modal-overlay" onclick="closeAddPatientModalOnOutside(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h2>
            <button class="btn-close-modal" onclick="closeAddPatientModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="queue-status-box" id="queueStatusBox" style="background: linear-gradient(135deg, #e8f4f8, #d4e9f7); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3498db;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <strong style="color: #2c3e50; font-size: 1.1em;">üîÑ ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</strong>
                        <span id="modalQueueNext" style="font-size: 1.2em; font-weight: 700; color: #e74c3c; margin-left: 10px;"></span>
                    </div>
                    <button class="btn btn-sm btn-warning" onclick="skipQueue()" style="padding: 6px 12px;">‚è≠Ô∏è ‡∏Ç‡πâ‡∏≤‡∏°</button>
                </div>
                <div id="skippedSlots" style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;"></div>
            </div>
            <div class="modal-field">
                <label>‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™</label>
                <select id="newStaff">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                    <option value="‡∏ô‡∏±‡∏ó">‡∏ô‡∏±‡∏ó</option>
                    <option value="‡πÄ‡∏≠‡∏¥‡∏á">‡πÄ‡∏≠‡∏¥‡∏á</option>
                    <option value="‡∏≠‡∏≤‡∏¢">‡∏≠‡∏≤‡∏¢</option>
                    <option value="other">‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á)</option>
                </select>
                <input type="text" id="newStaffCustom" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠" style="display: none; margin-top: 5px;">
            </div>
            <div class="modal-field">
                <label>Status</label>
                <select id="newStatus">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                    <option value="admit">Admit</option>
                    <option value="discharge">Discharge</option>
                </select>
            </div>
            <div class="modal-field">
                <label>‡∏ß‡∏≠‡∏£‡πå‡∏î</label>
                <input type="text" id="newWard" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3‡∏Ñ">
            </div>
            <div class="modal-field">
                <label>‡πÄ‡∏ï‡∏µ‡∏¢‡∏á</label>
                <input type="text" id="newBed" placeholder="‡πÄ‡∏ä‡πà‡∏ô 6">
            </div>
            <div class="modal-field">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                <input type="text" id="newName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="modal-field">
                <label>HN</label>
                <input type="text" id="newHN" placeholder="Hospital Number">
            </div>
            <div class="modal-field">
                <label>‡∏≠‡∏≤‡∏¢‡∏∏</label>
                <input type="text" id="newAge" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)">
            </div>
            <div class="modal-field">
                <label>Diagnosis</label>
                <input type="text" id="newDx" placeholder="‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏£‡∏Ñ">
            </div>
            <div class="modal-field">
                <label>Operation</label>
                <input type="text" id="newOperation" placeholder="‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î">
            </div>
            <div class="modal-field">
                <label>Admit Date</label>
                <input type="date" id="newAdmit">
            </div>
            <div class="modal-field">
                <label>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</label>
                <input type="text" id="newTeacher" placeholder="‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel-modal" onclick="closeAddPatientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button class="btn-submit-patient" onclick="submitNewPatient()">‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<!-- Color Settings Modal -->
<div id="colorSettingsModal" class="modal-overlay" onclick="closeColorSettingsModalOnOutside(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
        <div class="modal-header">
            <h2>üé® ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏™</h2>
            <button class="btn-close-modal" onclick="closeColorSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="modal-field">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                    <span>‡∏ô‡∏±‡∏ó</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="colorPreviewNat" style="width: 100px; height: 30px; border-radius: 5px; background: linear-gradient(135deg, #ff69b4 0%, #ff1493 100%);"></div>
                        <button class="btn btn-sm btn-primary" onclick="pickColor('‡∏ô‡∏±‡∏ó', 'pink')">Pink</button>
                        <button class="btn btn-sm btn-warning" onclick="pickColor('‡∏ô‡∏±‡∏ó', 'yellow')">Yellow</button>
                        <button class="btn btn-sm btn-info" onclick="pickColor('‡∏ô‡∏±‡∏ó', 'blue')">Blue</button>
                        <button class="btn btn-sm btn-success" onclick="pickColor('‡∏ô‡∏±‡∏ó', 'green')">Green</button>
                    </div>
                </label>
            </div>
            <div class="modal-field">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                    <span>‡πÄ‡∏≠‡∏¥‡∏á</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="colorPreviewEiong" style="width: 100px; height: 30px; border-radius: 5px; background: linear-gradient(135deg, #ffd700 0%, #ffb800 100%);"></div>
                        <button class="btn btn-sm btn-primary" onclick="pickColor('‡πÄ‡∏≠‡∏¥‡∏á', 'pink')">Pink</button>
                        <button class="btn btn-sm btn-warning" onclick="pickColor('‡πÄ‡∏≠‡∏¥‡∏á', 'yellow')">Yellow</button>
                        <button class="btn btn-sm btn-info" onclick="pickColor('‡πÄ‡∏≠‡∏¥‡∏á', 'blue')">Blue</button>
                        <button class="btn btn-sm btn-success" onclick="pickColor('‡πÄ‡∏≠‡∏¥‡∏á', 'green')">Green</button>
                    </div>
                </label>
            </div>
            <div class="modal-field">
                <label style="display: flex; align-items: center; justify-content: space-between;">
                    <span>‡∏≠‡∏≤‡∏¢</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <div id="colorPreviewAi" style="width: 100px; height: 30px; border-radius: 5px; background: linear-gradient(135deg, #00bfff 0%, #1e90ff 100%);"></div>
                        <button class="btn btn-sm btn-primary" onclick="pickColor('‡∏≠‡∏≤‡∏¢', 'pink')">Pink</button>
                        <button class="btn btn-sm btn-warning" onclick="pickColor('‡∏≠‡∏≤‡∏¢', 'yellow')">Yellow</button>
                        <button class="btn btn-sm btn-info" onclick="pickColor('‡∏≠‡∏≤‡∏¢', 'blue')">Blue</button>
                        <button class="btn btn-sm btn-success" onclick="pickColor('‡∏≠‡∏≤‡∏¢', 'green')">Green</button>
                    </div>
                </label>
            </div>
            <div class="modal-field" style="border-top: 2px solid #e9ecef; padding-top: 15px; margin-top: 15px;">
                <label style="font-weight: 700; color: #2c3e50; margin-bottom: 10px; display: block;">üè† ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Default View)</label>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="btn btn-sm btn-info" onclick="setDefaultView('table')" style="padding: 10px 20px; font-size: 1em;">üìä Table View</button>
                    <button class="btn btn-sm btn-primary" onclick="setDefaultView('card')" style="padding: 10px 20px; font-size: 1em;">üìã Card View</button>
                </div>
                <div style="text-align: center; margin-top: 8px; font-size: 0.85em; color: #7f8c8d;">
                    ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong id="currentDefaultView"></strong>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel-modal" onclick="resetColors()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
            <button class="btn-submit-patient" onclick="closeColorSettingsModal()">‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à</button>
        </div>
    </div>
</div>

<script type="module">
    // FIX: Swapped fake version 12.9.0 for a real, stable version 10.12.2
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, update, onDisconnect, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBg8Ub8RzxsCXGky8ZCpsX_53sjYXqE3gc",
        authDomain: "wardlive.firebaseapp.com",
        databaseURL: "https://wardlive-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "wardlive",
        storageBucket: "wardlive.firebasestorage.app",
        messagingSenderId: "998186109076",
        appId: "1:998186109076:web:3262ddd2de637391f08c81"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
// Generate a random local UID
    let myUid = localStorage.getItem("ward_uid");
    if (!myUid) {
        myUid = "user_" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("ward_uid", myUid);
    }

    let myName = localStorage.getItem("ward_username") || ""; 
    
    // --- NEW: GENERATE A UNIQUE COLOR ---
    let myColor = localStorage.getItem("ward_color");
    if (!myColor) {
        // Generate a random light/pastel hex color (so black text is still readable!)
        const r = Math.floor(Math.random() * 128) + 127; 
        const g = Math.floor(Math.random() * 128) + 127;
        const b = Math.floor(Math.random() * 128) + 127;
        myColor = "#" + r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0');
        localStorage.setItem("ward_color", myColor);
    }
    // ------------------------------------

    let allData = {};      
    let currentSheet = ""; 
    // Load default view from localStorage, fallback to 'table'
    let currentView = localStorage.getItem('default_view') || "table"; 
    let dropdownOptions = {}; // Store dropdown options for cells
    let unfilteredCardData = []; // Store unfiltered card data for sorting/filtering
    let cardColumnMap = {}; // Store column mapping for current sheet
    
    // PASTE YOUR WEB APP URL HERE
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztdQvnznmaYhNswYpVvXsFBXEcjR8UiQSGxVGYu9DhHaiZ1zSHUze9zJICiLd93hUHPA/exec";
    
    // Load custom staff colors from localStorage
    const defaultStaffColors = {
        '‡∏ô‡∏±‡∏ó': 'linear-gradient(135deg, #ff69b4 0%, #ff1493 100%)', // Pink
        '‡πÄ‡∏≠‡∏¥‡∏á': 'linear-gradient(135deg, #ffd700 0%, #ffb800 100%)', // Yellow
        '‡∏≠‡∏≤‡∏¢': 'linear-gradient(135deg, #00bfff 0%, #1e90ff 100%)'  // Blue
    };
    
    let staffColors = {};
    try {
        const saved = localStorage.getItem('staff_colors');
        staffColors = saved ? JSON.parse(saved) : {...defaultStaffColors};
    } catch (e) {
        staffColors = {...defaultStaffColors};
    }
    
    // Generate consistent color for each staff name
    function getStaffColor(name) {
        if (!name) return 'linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%)';
        
        const nameTrimmed = String(name).trim();
        
        // Check if custom color exists
        if (staffColors[nameTrimmed]) {
            return staffColors[nameTrimmed];
        }
        
        // Hash function for other names
        let hash = 0;
        for (let i = 0; i < nameTrimmed.length; i++) {
            hash = nameTrimmed.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        // Other vibrant colors
        const colors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', // Purple
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', // Pink Rose
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', // Orange
            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)', // Teal-Purple
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)', // Light Blue-Pink
            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)', // Peach
            'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)', // Purple-Blue
            'linear-gradient(135deg, #f8b500 0%, #fceabb 100%)', // Gold
        ];
        
        return colors[Math.abs(hash) % colors.length];
    }
    
    // Save staff color
    function saveStaffColor(name, color) {
        staffColors[name] = color;
        localStorage.setItem('staff_colors', JSON.stringify(staffColors));
    }
    
    // ===== QUEUE MANAGEMENT SYSTEM =====
    const STAFF_QUEUE = ['‡∏ô‡∏±‡∏ó', '‡πÄ‡∏≠‡∏¥‡∏á', '‡∏≠‡∏≤‡∏¢'];
    
    // Calculate next in queue based on last row in sheet
    function getNextInQueue() {
        if (!currentSheet || !allData[currentSheet]) {
            return STAFF_QUEUE[0]; // Default to first person
        }
        
        const sheetData = allData[currentSheet];
        const headers = sheetData[0] || [];
        
        // Find staff column index
        let staffColIdx = -1;
        let bedColIdx = -1;
        let nameColIdx = -1;
        
        headers.forEach((header, colIdx) => {
            const headerLower = String(header).toLowerCase();
            if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) staffColIdx = colIdx;
            else if (headerLower.includes('‡πÄ‡∏ï‡∏µ‡∏¢‡∏á') || headerLower.includes('bed')) bedColIdx = colIdx;
            else if (headerLower.includes('‡∏ä‡∏∑‡πà‡∏≠') || headerLower.includes('name')) nameColIdx = colIdx;
        });
        
        if (staffColIdx === -1) return STAFF_QUEUE[0];
        
        // Find last row with actual patient data (not just placeholder)
        let lastStaff = null;
        const rowKeys = Object.keys(sheetData)
            .map(k => parseInt(k))
            .filter(n => !isNaN(n) && n > 0) // Skip header row
            .sort((a, b) => a - b);
        
        // Search from last row backwards for a row with actual patient data
        for (let i = rowKeys.length - 1; i >= 0; i--) {
            const rowIdx = rowKeys[i];
            const row = sheetData[rowIdx];
            if (row && Array.isArray(row)) {
                const staff = String(row[staffColIdx] || '').trim();
                const bed = bedColIdx >= 0 ? String(row[bedColIdx] || '').trim() : '';
                const name = nameColIdx >= 0 ? String(row[nameColIdx] || '').trim() : '';
                
                // Found a row with staff and at least bed or name (not a placeholder)
                if (staff && (bed || name)) {
                    lastStaff = staff;
                    break;
                }
            }
        }
        
        // If no data found, start from beginning
        if (!lastStaff) return STAFF_QUEUE[0];
        
        // Calculate next in rotation
        const currentIndex = STAFF_QUEUE.indexOf(lastStaff);
        if (currentIndex === -1) return STAFF_QUEUE[0]; // Staff not in queue, start from beginning
        
        // Return next person in rotation
        return STAFF_QUEUE[(currentIndex + 1) % STAFF_QUEUE.length];
    }
    
    // Calculate skipped slots from placeholder rows in sheet
    function getSkippedSlots() {
        if (!currentSheet || !allData[currentSheet]) {
            return [];
        }
        
        const sheetData = allData[currentSheet];
        const headers = sheetData[0] || [];
        
        // Find column indices
        let staffColIdx = -1;
        let bedColIdx = -1;
        let nameColIdx = -1;
        
        headers.forEach((header, colIdx) => {
            const headerLower = String(header).toLowerCase();
            if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) staffColIdx = colIdx;
            else if (headerLower.includes('‡πÄ‡∏ï‡∏µ‡∏¢‡∏á') || headerLower.includes('bed')) bedColIdx = colIdx;
            else if (headerLower.includes('‡∏ä‡∏∑‡πà‡∏≠') || headerLower.includes('name')) nameColIdx = colIdx;
        });
        
        if (staffColIdx === -1) return [];
        
        // Find all placeholder rows (staff filled, but no bed/name)
        const skipped = [];
        const rowKeys = Object.keys(sheetData)
            .map(k => parseInt(k))
            .filter(n => !isNaN(n) && n > 0)
            .sort((a, b) => a - b);
        
        for (const rowIdx of rowKeys) {
            const row = sheetData[rowIdx];
            if (row && Array.isArray(row)) {
                const staff = String(row[staffColIdx] || '').trim();
                const bed = bedColIdx >= 0 ? String(row[bedColIdx] || '').trim() : '';
                const name = nameColIdx >= 0 ? String(row[nameColIdx] || '').trim() : '';
                
                // Placeholder: has staff but no bed AND no name
                if (staff && !bed && !name && !skipped.includes(staff)) {
                    skipped.push(staff);
                }
            }
        }
        
        return skipped;
    }
    
    async function skipQueue() {
        const currentStaff = getNextInQueue();
        const skippedSlots = getSkippedSlots();
        
        // Add to skipped slots if not already there
        if (!skippedSlots.includes(currentStaff)) {
            
            // Create placeholder row in sheet
            if (currentSheet && allData[currentSheet]) {
                try {
                    const sheetData = allData[currentSheet];
                    
                    // Find last continuous row
                    const rowKeys = Object.keys(sheetData).map(k => parseInt(k)).filter(n => !isNaN(n)).sort((a, b) => a - b);
                    let lastContinuousRow = 0;
                    for (let i = 0; i < rowKeys.length; i++) {
                        if (rowKeys[i] === i) {
                            lastContinuousRow = i;
                        } else {
                            break;
                        }
                    }
                    const newRowIndex = lastContinuousRow + 1;
                    
                    // Get headers and create placeholder row
                    const headers = sheetData[0] || [];
                    const placeholderRow = new Array(headers.length).fill('');
                    
                    // Fill in only the staff name
                    headers.forEach((header, colIdx) => {
                        const headerLower = String(header).toLowerCase();
                        if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) {
                            placeholderRow[colIdx] = currentStaff;
                        }
                    });
                    
                    // Add to Firebase
                    await set(ref(db, `sheets/${currentSheet}/${newRowIndex}`), placeholderRow);
                    console.log('‚úÖ Placeholder row created for:', currentStaff);
                    
                    // Sync to Google Sheets
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        redirect: 'follow',
                        body: JSON.stringify({
                            action: 'addRow',
                            sheetName: currentSheet,
                            rowIndex: newRowIndex,
                            rowData: placeholderRow
                        })
                    }).catch(error => console.error('Error syncing placeholder:', error));
                    
                } catch (error) {
                    console.error('Error creating placeholder:', error);
                }
            }
        }
        
        // Update display (queue will auto-calculate from new data)
        updateQueueDisplay();
    }
    
    function fillSkippedSlot(staffName) {
        // Open the add patient modal with this staff pre-selected
        document.getElementById('newStaff').value = staffName;
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newAdmit').value = today;
        
        // Update queue display in modal
        updateQueueDisplay();
        
        // Show modal
        document.getElementById('addPatientModal').classList.add('show');
    }
    
    function updateQueueDisplay() {
        const nextStaff = getNextInQueue();
        const color = getStaffColor(nextStaff);
        
        // Update main queue indicator
        const queueNextEl = document.getElementById('queueNext');
        if (queueNextEl) {
            queueNextEl.textContent = nextStaff;
            queueNextEl.style.background = color;
            queueNextEl.style.padding = '4px 12px';
            queueNextEl.style.borderRadius = '6px';
            queueNextEl.style.color = 'white';
            queueNextEl.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
        }
        
        // Update modal queue indicator
        const modalQueueNext = document.getElementById('modalQueueNext');
        if (modalQueueNext) {
            modalQueueNext.textContent = nextStaff;
            modalQueueNext.style.background = color;
            modalQueueNext.style.padding = '4px 12px';
            modalQueueNext.style.borderRadius = '6px';
            modalQueueNext.style.color = 'white';
            modalQueueNext.style.textShadow = '0 1px 2px rgba(0,0,0,0.3)';
        }
        
        // Update skipped slots display (calculated from sheet data)
        const skippedSlots = getSkippedSlots();
        const skippedSlotsEl = document.getElementById('skippedSlots');
        if (skippedSlotsEl) {
            if (skippedSlots.length > 0) {
                const slotsHtml = skippedSlots.map(staff => {
                    const staffColor = getStaffColor(staff);
                    return `<button class="btn btn-sm" 
                        onclick="fillSkippedSlot('${staff}')" 
                        style="background: ${staffColor}; color: white; margin-right: 5px; padding: 4px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                        ${staff} (\u0e40\u0e27\u0e49\u0e19\u0e44\u0e27\u0e49)
                    </button>`;
                }).join('');
                skippedSlotsEl.innerHTML = `<strong>\ud83d\udccc \u0e2a\u0e25\u0e47\u0e2d\u0e15\u0e17\u0e35\u0e48\u0e40\u0e27\u0e49\u0e19\u0e44\u0e27\u0e49:</strong><br>${slotsHtml}`;
                skippedSlotsEl.style.display = 'block';
            } else {
                skippedSlotsEl.style.display = 'none';
            }
        }
    }
    
    window.skipQueue = skipQueue;
    window.fillSkippedSlot = fillSkippedSlot;
    // ===== END QUEUE MANAGEMENT =====
    
    // --- LOGIN LOGIC ---
    const overlay = document.getElementById('loginOverlay');
    const nameInput = document.getElementById('guestName');
    const btnEnter = document.getElementById('btnEnter');

    if (myName) {
        enterDashboard();
    } else {
        overlay.style.display = 'flex';
    }

    btnEnter.addEventListener('click', () => {
        const name = nameInput.value.trim();
        if (!name) return alert("Please enter a name");
        
        myName = name;
        localStorage.setItem("ward_username", name);
        enterDashboard();
    });

    nameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') btnEnter.click();
    });

    window.changeName = () => {
        localStorage.removeItem("ward_username");
        location.reload();
    };

    // --- APP START ---
    function enterDashboard() {
        overlay.style.display = 'none';
        document.getElementById('userDisplay').innerText = myName;
        
        onDisconnect(ref(db, `presence/${myUid}`)).remove();
        startApp();
    }

    // Trigger initial sync from Google Sheets on page load
    function syncFromGoogleSheets() {
        console.log('üîÑ Syncing fresh data from Google Sheets...');
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            redirect: 'follow',
            body: JSON.stringify({ action: 'sync' })
        }).then(response => {
            if (response.ok) {
                console.log('‚úÖ Sync complete! Data refreshed from Google Sheets');
            } else {
                console.error('‚ùå Sync failed');
            }
        }).catch(error => {
            console.error('‚ùå Sync error:', error);
        });
    }

    function startApp() {
        // Sync fresh data from Google Sheets on every page load
        syncFromGoogleSheets();
        
        // Initialize view based on saved preference
        document.getElementById('btnTableView').classList.toggle('active', currentView === 'table');
        document.getElementById('btnCardView').classList.toggle('active', currentView === 'card');
        document.querySelector('.table-responsive').style.display = currentView === 'table' ? 'block' : 'none';
        document.getElementById('cardView').classList.toggle('active', currentView === 'card');
        
        // Initialize queue display
        updateQueueDisplay();
        
        // 1. Fetch ALL sheets
        // FIX: Added an error handler. If Firebase blocks you, it will tell you!
onValue(ref(db, 'sheets'), (snapshot) => {
    const data = snapshot.val();
    if(!data) return; // Handle empty data
    
    // Check if the sheet I am looking at still exists
    const sheetExists = data.hasOwnProperty(currentSheet);

    allData = data;

    // If my current sheet was deleted by someone else
    if (currentSheet !== "" && !sheetExists) {
        alert("‚ö†Ô∏è The sheet you were viewing has been deleted or renamed.");
        currentSheet = Object.keys(data)[0]; // Switch to the first available sheet
    } else if (currentSheet === "") {
        currentSheet = Object.keys(data)[0];
    }
    
    renderTabs();
    if (currentView === 'table') {
        renderTable(currentSheet);
    } else {
        renderCards(currentSheet, false);
    }
}, (error) => {
    console.error(error);
});

        // Fetch dropdown options
        onValue(ref(db, 'dropdowns'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                dropdownOptions = data;
                const summary = Object.keys(dropdownOptions).map(sheet => {
                    const cellCount = Object.keys(dropdownOptions[sheet] || {}).length;
                    return `${sheet} (${cellCount} cells)`;
                }).join(' | ');
                console.log('‚úÖ Dropdowns loaded:', summary);
                
                // FORCE FULL RE-RENDER by clearing the table body first
                if (currentSheet) {
                    if (currentView === 'table') {
                        document.getElementById('tableBody').innerHTML = ''; // Clear to force full render
                        renderTable(currentSheet);
                    } else {
                        document.getElementById('cardContainer').innerHTML = ''; // Clear to force full render
                        renderCards(currentSheet, true);
                    }
                }
            }
        });

        // 2. Presence System (Who is editing)
        onValue(ref(db, 'presence'), (snapshot) => {
            const users = snapshot.val() || {};
            document.querySelectorAll('.being-edited').forEach(el => {
                el.classList.remove('being-edited');
                el.removeAttribute('title');
            });
            
            Object.keys(users).forEach(userId => {
                if (userId === myUid) return; 
                const u = users[userId];
                
                if (u.sheet === currentSheet) {
                    // Check both table view and card view
                    const tableCell = document.getElementById(`cell-${u.row}-${u.col}`);
                    const cardCell = document.getElementById(`card-cell-${u.row}-${u.col}`);
                    
                    if (tableCell) {
                        tableCell.classList.add('being-edited');
                        tableCell.title = `${u.name} is editing...`; 
                    }
                    if (cardCell) {
                        cardCell.classList.add('being-edited');
                        cardCell.title = `${u.name} is editing...`; 
                    }
                }
            });
        });
    }

    function renderTabs() {
        const tabContainer = document.getElementById('sheetTabs');
        let html = "";
        Object.keys(allData).forEach(sheetName => {
            const isActive = (sheetName === currentSheet) ? 'active' : '';
            html += `<li class="nav-item">
                <a class="nav-link ${isActive}" onclick="switchTab('${sheetName}')">${sheetName}</a>
            </li>`;
        });
        tabContainer.innerHTML = html;
        document.getElementById('sheetNameDisplay').innerText = currentSheet;
    }

    window.switchTab = (sheetName) => {
        currentSheet = sheetName;
        
        // Clear filters and dropdown population flags for new sheet
        const filterWard = document.getElementById('filterWard');
        const filterStaff = document.getElementById('filterStaff');
        const filterStatus = document.getElementById('filterStatus');
        const sortBy = document.getElementById('sortBy');
        
        if (filterWard) {
            filterWard.value = '';
            filterWard.hasOptions = false;
        }
        if (filterStaff) {
            filterStaff.value = '';
            filterStaff.hasOptions = false;
        }
        if (filterStatus) filterStatus.value = '';
        if (sortBy) sortBy.value = '';
        
        renderTabs();
        if (currentView === 'table') {
            renderTable(sheetName);
        } else {
            renderCards(sheetName, true);
        }
    };

    window.switchView = (view) => {
        currentView = view;
        
        // Update button states
        document.getElementById('btnTableView').classList.toggle('active', view === 'table');
        document.getElementById('btnCardView').classList.toggle('active', view === 'card');
        
        // Toggle view containers
        document.querySelector('.table-responsive').style.display = view === 'table' ? 'block' : 'none';
        document.getElementById('cardView').classList.toggle('active', view === 'card');
        
        // Render the appropriate view
        if (view === 'table') {
            renderTable(currentSheet);
        } else {
            renderCards(currentSheet, true); // Force full render with filters
        }
    };

    // Set default view preference
    window.setDefaultView = (view) => {
        localStorage.setItem('default_view', view);
        // Update display immediately
        document.getElementById('currentDefaultView').textContent = view === 'table' ? 'üìä Table View' : 'üìã Card View';
        alert(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${view === 'table' ? 'Table View' : 'Card View'} ‡πÅ‡∏•‡πâ‡∏ß`);
    };

    // Helper function to create input or dropdown based on cell data validation
    function createCellInput(r, c, value, idPrefix = 'cell', inputType = 'text') {
        const sheetDropdowns = dropdownOptions[currentSheet] || {};
        // Check if this specific cell has dropdown options
        const cellKey = `${r}_${c}`;
        const options = sheetDropdowns[cellKey];
        
        // Escape HTML special characters in value
        const escapeHtml = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };
        const safeValue = escapeHtml(String(value || ''));
        
        if (options && options.length > 0) {
            // Create dropdown
            let html = `<select 
                id="${idPrefix}-${r}-${c}" 
                class="cell-input" 
                onfocus="setFocus(${r}, ${c})" 
                onblur="removeFocus(${r}, ${c})"
                onchange="updateData(${r}, ${c}, this.value)">`;
            html += `<option value="">${value === '' ? '-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --' : ''}</option>`;
            options.forEach(opt => {
                const safeOpt = escapeHtml(String(opt));
                const selected = opt === value ? 'selected' : '';
                html += `<option value="${safeOpt}" ${selected}>${safeOpt}</option>`;
            });
            html += `</select>`;
            return html;
        } else {
            // Create regular input or date input
            const sizeAttr = inputType === 'date' ? '' : `size="${Math.max(6, String(value || '').length + 6)}"`;
            return `<input 
                type="${inputType}"
                id="${idPrefix}-${r}-${c}" 
                class="cell-input" 
                value="${safeValue}" 
                ${sizeAttr}
                onfocus="setFocus(${r}, ${c})" 
                onblur="removeFocus(${r}, ${c})"
                oninput="autoResizeInput(this)"
                onchange="updateData(${r}, ${c}, this.value)">`;
        }
    }

function renderTable(sheetName) {
        if (!allData[sheetName]) return;
        let rawData = allData[sheetName];
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');

        // Convert Firebase object structure to proper 2D array
        const data = [];
        const rowIndices = Object.keys(rawData).map(Number).filter(n => !isNaN(n));
        const maxRowIndex = rowIndices.length > 0 ? Math.max(...rowIndices) : 0;
        
        // Determine number of columns from header row
        let numCols = 20; // default
        if (rawData[0]) {
            const headerRow = rawData[0];
            if (typeof headerRow === 'object' && !Array.isArray(headerRow)) {
                const colIndices = Object.keys(headerRow).map(Number).filter(n => !isNaN(n));
                numCols = colIndices.length > 0 ? Math.max(...colIndices) + 1 : 20;
            } else if (Array.isArray(headerRow)) {
                numCols = headerRow.length;
            }
        }
        
        for (let i = 0; i <= maxRowIndex; i++) {
            if (rawData[i]) {
                const row = rawData[i];
                // Convert row to array if it's an object
                if (typeof row === 'object' && !Array.isArray(row)) {
                    const colKeys = Object.keys(row).map(Number).filter(n => !isNaN(n));
                    const maxColIndex = colKeys.length > 0 ? Math.max(...colKeys) : numCols - 1;
                    data[i] = [];
                    for (let j = 0; j <= Math.max(maxColIndex, numCols - 1); j++) {
                        data[i][j] = row[j] !== undefined && row[j] !== null ? row[j] : '';
                    }
                } else if (Array.isArray(row)) {
                    data[i] = row;
                } else {
                    // Handle completely empty row stored as null or undefined
                    data[i] = Array(numCols).fill('');
                }
            } else {
                // Row doesn't exist in Firebase - create empty row
                data[i] = Array(numCols).fill('');
            }
        }

        // 1. Render Header
        let headHtml = "<tr>";
        (data[0] || []).forEach(h => headHtml += `<th>${h}</th>`);
        headHtml += "</tr>";
        tableHead.innerHTML = headHtml;

        // 2. Render Body (Smart Update)
        const currentRowsCount = tableBody.querySelectorAll('tr').length;
        const expectedRowsCount = data.length - 1; // Exclude header row
        const numColumns = data[0] ? data[0].length : 0;

        // If the table is completely empty, build it from scratch
        if (currentRowsCount === 0 || currentRowsCount !== expectedRowsCount) {
            let bodyHtml = "";
            data.forEach((row, r) => {
                if (r === 0) return; 
                bodyHtml += "<tr>";
                // Always create the same number of cells as columns in header
                for (let c = 0; c < numColumns; c++) {
                    const cell = row[c] || '';
                    bodyHtml += `<td class="p-0">${createCellInput(r, c, cell, 'cell')}</td>`;
                }
                bodyHtml += "</tr>";
            });
            tableBody.innerHTML = bodyHtml;
        } else {
            // If the table already exists, just update the data inside the boxes!
            data.forEach((row, r) => {
                if (r === 0) return;
                for (let c = 0; c < numColumns; c++) {
                    const element = document.getElementById(`cell-${r}-${c}`);
                    if (element) {
                        // CRITICAL: Update the box ONLY if the user isn't currently typing in it
                        if (document.activeElement !== element) {
                            element.value = row[c] || '';
                        }
                    }
                }
            });
        }
    }

function renderCards(sheetName, forceFullRender = false) {
        if (!allData[sheetName]) return;
        let rawData = allData[sheetName];

        // Convert Firebase object structure to proper 2D array (same as renderTable)
        const data = [];
        const rowIndices = Object.keys(rawData).map(Number).filter(n => !isNaN(n));
        const maxRowIndex = rowIndices.length > 0 ? Math.max(...rowIndices) : 0;
        
        let numCols = 20;
        if (rawData[0]) {
            const headerRow = rawData[0];
            if (typeof headerRow === 'object' && !Array.isArray(headerRow)) {
                const colIndices = Object.keys(headerRow).map(Number).filter(n => !isNaN(n));
                numCols = colIndices.length > 0 ? Math.max(...colIndices) + 1 : 20;
            } else if (Array.isArray(headerRow)) {
                numCols = headerRow.length;
            }
        }
        
        for (let i = 0; i <= maxRowIndex; i++) {
            if (rawData[i]) {
                const row = rawData[i];
                if (typeof row === 'object' && !Array.isArray(row)) {
                    const colKeys = Object.keys(row).map(Number).filter(n => !isNaN(n));
                    const maxColIndex = colKeys.length > 0 ? Math.max(...colKeys) : numCols - 1;
                    data[i] = [];
                    for (let j = 0; j <= Math.max(maxColIndex, numCols - 1); j++) {
                        data[i][j] = row[j] !== undefined && row[j] !== null ? row[j] : '';
                    }
                } else if (Array.isArray(row)) {
                    data[i] = row;
                } else {
                    data[i] = Array(numCols).fill('');
                }
            } else {
                data[i] = Array(numCols).fill('');
            }
        }

        const headers = data[0] || [];
        
        // Find column indices
        const colMap = {};
        headers.forEach((h, idx) => {
            const headerLower = String(h).toLowerCase();
            if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) colMap.staff = idx;
            else if (headerLower.includes('status')) colMap.status = idx;
            else if (headerLower.includes('‡∏ß‡∏≠‡∏£‡πå‡∏î') || headerLower.includes('ward')) colMap.ward = idx;
            else if (headerLower.includes('‡πÄ‡∏ï‡∏µ‡∏¢‡∏á') || headerLower.includes('bed')) colMap.bed = idx;
            else if (headerLower.includes('hn')) colMap.hn = idx;
            else if (headerLower.includes('‡∏ä‡∏∑‡πà‡∏≠') || headerLower.includes('name')) colMap.name = idx;
            else if (headerLower.includes('‡∏≠‡∏≤‡∏¢‡∏∏') || headerLower.includes('age')) colMap.age = idx;
            else if (headerLower.includes('dx') || headerLower.includes('diagnosis')) colMap.dx = idx;
            else if (headerLower.includes('admit')) colMap.admit = idx;
            else if (headerLower.includes('operation') && !headerLower.includes('post')) colMap.operation = idx;
            else if (headerLower.includes('‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå') || headerLower.includes('teacher')) colMap.teacher = idx;
        });
        
        // Store globally for filter/sort functions
        cardColumnMap = colMap;
        unfilteredCardData = data;
        
        // Debug column mapping
        console.log('Card view column mapping:', colMap);
        console.log('Headers:', headers);
        
        // Helper to create field
        const createField = (r, c, label, isImportant = false, isDate = false) => {
            if (!data[r]) return '';
            
            const value = data[r][c] || '';
            const importantClass = isImportant ? 'important' : '';
            
            // Set default date to today if date field is empty
            let displayValue = value;
            if (isDate && !value) {
                displayValue = new Date().toISOString().split('T')[0];
            }
            
            const inputType = isDate ? 'date' : 'text';
            const input = createCellInput(r, c, displayValue, 'card-cell', inputType);
            
            return `<div class="card-field ${importantClass}">
                <label>${label}</label>
                ${input}
            </div>`;
        };
        
        // Populate filter dropdowns ONLY if not yet populated (don't reset user's selection!)
        if (!document.getElementById('filterWard').hasOptions) {
            populateFilterDropdowns(data, colMap);
        }
        
        // Apply current filters and sorting
        const filterResult = applyCurrentFilters(data, colMap);
        const filteredRows = filterResult.filteredRows;
        
        // Check if cards already exist
        const cardContainer = document.getElementById('cardContainer');
        const existingCards = cardContainer.querySelectorAll('.patient-card').length;
        const hasExistingCards = existingCards > 0 && !forceFullRender;

        if (hasExistingCards) {
            // Smart update: just update the values (only works when not filtering)
            data.forEach((row, r) => {
                if (r === 0) return;
                if (!row) return;
                row.forEach((cell, c) => {
                    const element = document.getElementById(`card-cell-${r}-${c}`);
                    if (element && document.activeElement !== element) {
                        element.value = cell || '';
                    }
                });
            });
        } else {
            // Full render with compact format
            let html = "";

            // Render each filtered row as a compact card
            filteredRows.forEach(({row, originalIndex}) => {
                const r = originalIndex; // Use original index for input field IDs
                
                // Determine card class based on status
                const status = row[colMap.status] ? String(row[colMap.status]).toLowerCase() : '';
                let cardClass = 'patient-card';
                if (status.includes('d/c') || status.includes('discharge')) cardClass += ' status-discharge';
                else if (status.includes('critical') || status.includes('icu')) cardClass += ' status-critical';
                else if (status.includes('pending') || status.includes('wait')) cardClass += ' status-pending';
                else cardClass += ' status-active';
                
                html += `<div class="${cardClass}" id="card-${r}">`;
                
                // Line 1: Staff (Badge) + Status (Badge) + Expand + Delete buttons
                html += `<div class="card-compact-line first-line">`;
                if (colMap.staff !== undefined) {
                    const staffName = row[colMap.staff] || '';
                    const staffColor = getStaffColor(staffName);
                    // Create staff dropdown
                    const staffDropdown = `<select 
                        id="card-cell-${r}-${colMap.staff}" 
                        class="cell-input staff-select" 
                        onfocus="setFocus(${r}, ${colMap.staff})" 
                        onblur="removeFocus(${r}, ${colMap.staff})"
                        onchange="updateData(${r}, ${colMap.staff}, this.value)">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                        <option value="‡∏ô‡∏±‡∏ó" ${staffName === '‡∏ô‡∏±‡∏ó' ? 'selected' : ''}>‡∏ô‡∏±‡∏ó</option>
                        <option value="‡πÄ‡∏≠‡∏¥‡∏á" ${staffName === '‡πÄ‡∏≠‡∏¥‡∏á' ? 'selected' : ''}>‡πÄ‡∏≠‡∏¥‡∏á</option>
                        <option value="‡∏≠‡∏≤‡∏¢" ${staffName === '‡∏≠‡∏≤‡∏¢' ? 'selected' : ''}>‡∏≠‡∏≤‡∏¢</option>
                        <option value="${staffName}" ${staffName && staffName !== '‡∏ô‡∏±‡∏ó' && staffName !== '‡πÄ‡∏≠‡∏¥‡∏á' && staffName !== '‡∏≠‡∏≤‡∏¢' ? 'selected' : ''}>${staffName && staffName !== '‡∏ô‡∏±‡∏ó' && staffName !== '‡πÄ‡∏≠‡∏¥‡∏á' && staffName !== '‡∏≠‡∏≤‡∏¢' ? staffName : '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}</option>
                    </select>`;
                    html += `<span class="badge-staff" style="background: ${staffColor};">${staffDropdown}</span>`;
                }
                if (colMap.status !== undefined) {
                    const statusVal = row[colMap.status] || 'Active';
                    const statusLower = statusVal.toLowerCase();
                    let badgeClass = 'badge-status default';
                    if (statusLower.includes('d/c') || statusLower.includes('discharge')) badgeClass = 'badge-status discharge';
                    else if (statusLower) badgeClass = 'badge-status active';
                    
                    // Create status dropdown with Active and D/C options
                    const statusDropdown = `<select 
                        id="card-cell-${r}-${colMap.status}" 
                        class="cell-input status-select" 
                        onfocus="setFocus(${r}, ${colMap.status})" 
                        onblur="removeFocus(${r}, ${colMap.status})"
                        onchange="updateData(${r}, ${colMap.status}, this.value)">
                        <option value="Active" ${statusVal === 'Active' ? 'selected' : ''}>Active</option>
                        <option value="D/C" ${statusVal === 'D/C' || statusLower.includes('d/c') || statusLower.includes('discharge') ? 'selected' : ''}>D/C</option>
                    </select>`;
                    html += `<span class="${badgeClass}">${statusDropdown}</span>`;
                }
                // Spacer before buttons
                html += `<span style="flex: 1;"></span>`;
                // Expand button
                html += `<button class="btn-expand-card" onclick="toggleCardExpand(${r})" title="‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°">üìã</button>`;
                // Small gap
                html += `<span style="width: 8px;"></span>`;
                // Delete button
                html += `<button class="btn-delete-card" onclick="deleteRow(${r})" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ">üóëÔ∏è ‡∏•‡∏ö</button>`;
                html += `</div>`;
                
                // Line 2: Ward/Bed PatientName HN (with colored background)
                html += `<div class="card-compact-line location-line">`;
                if (colMap.ward !== undefined && colMap.bed !== undefined) {
                    html += `<span class="location-badge">`;
                    html += `<span style="font-size: 1.1em;">üìç</span>`;
                    html += `<span class="card-inline-field narrow">${createCellInput(r, colMap.ward, row[colMap.ward] || '', 'card-cell')}</span>`;
                    html += `<span class="location-divider">/</span>`;
                    const bedInput = createCellInput(r, colMap.bed, row[colMap.bed] || '', 'card-cell');
                    html += `<span class="bed-number card-inline-field narrow">${bedInput}</span>`;
                    html += `</span>`;
                }
                if (colMap.name !== undefined) {
                    html += `<span class="card-inline-field wide" style="font-size: 1.2em; color: #2c3e50;">${createCellInput(r, colMap.name, row[colMap.name] || '', 'card-cell')}</span>`;
                }
                if (colMap.hn !== undefined) {
                    html += `<span class="info-label" style="font-weight: 600; font-size: 0.95em;">HN</span>`;
                    html += `<span class="card-inline-field" style="font-weight: 600;">${createCellInput(r, colMap.hn, row[colMap.hn] || '', 'card-cell')}</span>`;
                }
                html += `</div>`;
                
                // Line 3: Diagnosis (with colored background and icon)
                if (colMap.dx !== undefined && row[colMap.dx]) {
                    html += `<div class="card-compact-line diagnosis-line">`;
                    html += `<span class="diagnosis-tag">ü©∫</span>`;
                    html += `<span class="card-inline-field diagnosis-field">${createCellInput(r, colMap.dx, row[colMap.dx], 'card-cell')}</span>`;
                    html += `</div>`;
                }
                
                // Line 4: Operation (if exists, with colored background)
                if (colMap.operation !== undefined && row[colMap.operation]) {
                    html += `<div class="card-compact-line diagnosis-line">`;
                    html += `<span class="diagnosis-tag">‚öïÔ∏è</span>`;
                    html += `<span class="card-inline-field diagnosis-field">${createCellInput(r, colMap.operation, row[colMap.operation], 'card-cell')}</span>`;
                    html += `</div>`;
                }
                
                // Last line: Admit date and other key fields
                html += `<div class="card-compact-line admit-line">`;
                if (colMap.admit !== undefined) {
                    const admitValue = row[colMap.admit] || new Date().toISOString().split('T')[0];
                    html += `<span class="info-label" style="font-weight: 700; font-size: 1em;">üìÖ Admit</span>`;
                    html += `<span class="card-inline-field" style="font-weight: 600;">${createCellInput(r, colMap.admit, admitValue, 'card-cell', 'date')}</span>`;
                }
                if (colMap.teacher !== undefined && row[colMap.teacher]) {
                    html += `<span style="color: #bdc3c7; margin: 0 6px;">‚Ä¢</span>`;
                    html += `<span class="info-label" style="font-weight: 600;">üë®‚Äç‚öïÔ∏è</span>`;
                    html += `<span class="card-inline-field">${createCellInput(r, colMap.teacher, row[colMap.teacher], 'card-cell')}</span>`;
                }
                if (colMap.age !== undefined && row[colMap.age]) {
                    html += `<span style="color: #bdc3c7; margin: 0 6px;">‚Ä¢</span>`;
                    html += `<span class="info-label" style="font-weight: 700; font-size: 1em;">Age</span>`;
                    html += `<span class="card-inline-field narrow" style="font-weight: 700; font-size: 1.05em; color: #2c3e50;">${createCellInput(r, colMap.age, row[colMap.age], 'card-cell')}</span>`;
                }
                html += `</div>`;
                
                // Expanded details section (hidden by default)
                html += `<div class="card-expanded-details" id="expanded-${r}" style="display: none;">`;
                html += `<div class="expanded-header">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>`;
                html += `<div class="expanded-grid">`;
                
                // Show ALL fields from the sheet
                headers.forEach((header, colIdx) => {
                    if (colIdx !== colMap.staff && colIdx !== colMap.status && 
                        colIdx !== colMap.ward && colIdx !== colMap.bed && 
                        colIdx !== colMap.name && colIdx !== colMap.hn && 
                        colIdx !== colMap.dx && colIdx !== colMap.operation && 
                        colIdx !== colMap.admit && colIdx !== colMap.teacher && 
                        colIdx !== colMap.age && header) {
                        const cellValue = row[colIdx] || '';
                        html += `<div class="expanded-field">`;
                        html += `<label>${header}</label>`;
                        html += createCellInput(r, colIdx, cellValue, 'card-cell');
                        html += `</div>`;
                    }
                });
                
                html += `</div>`;
                html += `</div>`; // Close card-expanded-details
                
                html += `</div>`; // Close patient-card
            });

            cardContainer.innerHTML = html || '<p class="text-center text-muted p-5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á</p>';
            
            // Initialize input sizes based on content
            setTimeout(() => {
                cardContainer.querySelectorAll('input[type="text"]').forEach(input => {
                    autoResizeInput(input);
                });
            }, 0);
            
            // Update results count
            const totalCount = data.filter((row, idx) => {
                if (idx === 0) return false;
                return row && row.some(cell => cell && cell !== '');
            }).length;
            updateResultsCount(filteredRows.length, totalCount);
        }
    }
    
    // Populate filter dropdowns with unique values from data
    function populateFilterDropdowns(data, colMap) {
        const wards = new Set();
        const staff = new Set();
        
        console.log('Populating dropdowns with colMap:', colMap);
        
        data.forEach((row, idx) => {
            if (idx === 0) return; // Skip header
            
            if (colMap.ward !== undefined && row[colMap.ward]) {
                wards.add(String(row[colMap.ward]).trim());
            }
            if (colMap.staff !== undefined && row[colMap.staff]) {
                const staffValue = String(row[colMap.staff]).trim();
                staff.add(staffValue);
                console.log(`Row ${idx}: staff value = "${staffValue}"`);
            }
        });
        
        console.log('Unique staff values:', Array.from(staff));
        
        // Populate ward dropdown
        const filterWard = document.getElementById('filterWard');
        filterWard.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
        Array.from(wards).sort().forEach(w => {
            filterWard.innerHTML += `<option value="${w}">${w}</option>`;
        });
        filterWard.hasOptions = true;
        
        // Populate staff dropdown
        const filterStaff = document.getElementById('filterStaff');
        filterStaff.innerHTML = '<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>';
        Array.from(staff).sort().forEach(s => {
            filterStaff.innerHTML += `<option value="${s}">${s}</option>`;
        });
        filterStaff.hasOptions = true;
        
        console.log('Staff dropdown populated with:', filterStaff.options.length, 'options');
        for (let i = 0; i < filterStaff.options.length; i++) {
            console.log(`  Option ${i}: value="${filterStaff.options[i].value}" text="${filterStaff.options[i].text}"`);
        }
    }
    
    // Apply current filter and sort settings  
    function applyCurrentFilters(data, colMap) {
        const filterWardEl = document.getElementById('filterWard');
        const filterStaffEl = document.getElementById('filterStaff');
        const filterStatusEl = document.getElementById('filterStatus');
        const sortByEl = document.getElementById('sortBy');
        
        if (!filterStaffEl) {
            console.error('‚ùå filterStaff element not found!');
            return {header: data[0], filteredRows: []};
        }
        
        const filterWard = filterWardEl ? filterWardEl.value : '';
        const filterStaff = filterStaffEl.value;
        const filterStatus = filterStatusEl ? filterStatusEl.value : '';
        const sortBy = sortByEl ? sortByEl.value : '';
        
        console.log('=== FILTER APPLIED ===');
        console.log('Filter values:', {filterWard, filterStaff, filterStatus, sortBy});
        console.log('Column map:', colMap);
        console.log('Staff column index:', colMap.staff);
        
        // Start with header
        const header = data[0];
        
        // Filter data rows (skip header)
        let filteredRows = [];
        for (let idx = 1; idx < data.length; idx++) {
            const row = data[idx];
            
            // Skip completely empty rows - check for KEY patient fields only
            if (!row || !Array.isArray(row)) continue;
            
            // A row is considered valid if it has at least ONE of these key fields filled:
            // - Staff name (‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö)
            // - Bed number (‡πÄ‡∏ï‡∏µ‡∏¢‡∏á)
            // - Patient name (‡∏ä‡∏∑‡πà‡∏≠)
            // - HN number
            let hasKeyData = false;
            
            const keyColumns = [colMap.staff, colMap.bed, colMap.name, colMap.hn];
            for (let colIdx of keyColumns) {
                if (colIdx !== undefined && row[colIdx]) {
                    const val = String(row[colIdx]).trim();
                    if (val !== '' && val.length > 0) {
                        hasKeyData = true;
                        break;
                    }
                }
            }
            
            if (!hasKeyData) continue;
            
            let passesFilter = true;
            
            // Apply ward filter
            if (filterWard) {
                const val = colMap.ward !== undefined ? String(row[colMap.ward] || '').trim() : '';
                if (val !== filterWard) passesFilter = false;
            }
            
            // Apply staff filter
            if (filterStaff && passesFilter) {
                const val = colMap.staff !== undefined ? String(row[colMap.staff] || '').trim() : '';
                const matches = val === filterStaff;
                if (idx <= 5) { // Log first 5 rows for debugging
                    console.log(`Row ${idx}: staff="${val}" vs filter="${filterStaff}" (match: ${matches})`);
                }
                if (!matches) passesFilter = false;
            }
            
            // Apply status filter
            if (filterStatus && passesFilter) {
                const val = colMap.status !== undefined ? String(row[colMap.status] || '').toLowerCase().trim() : '';
                // Handle both "discharge" and "d/c" formats
                if (filterStatus.toLowerCase() === 'discharge') {
                    const isDischarge = val.includes('discharge') || val.includes('d/c') || val === 'd/c';
                    if (!isDischarge) passesFilter = false;
                } else if (filterStatus.toLowerCase() === 'active') {
                    // Active means NOT discharge
                    const isDischarge = val.includes('discharge') || val.includes('d/c') || val === 'd/c';
                    const isActive = val.includes('active') || val === 'active' || (!val) || !isDischarge;
                    if (isDischarge) passesFilter = false; // Exclude discharge from active
                } else if (!val.includes(filterStatus.toLowerCase())) {
                    passesFilter = false;
                }
            }
            
            // If row passes all filters, add it
            if (passesFilter) {
                filteredRows.push({row, originalIndex: idx});
            }
        }
        
        // Apply sorting
        if (sortBy && colMap.bed !== undefined) {
            filteredRows.sort((a, b) => {
                const aVal = String(a.row[colMap.bed] || '').trim();
                const bVal = String(b.row[colMap.bed] || '').trim();
                
                // Helper function to extract the highest number from strings like "6->18" or "6"
                const extractSortNumber = (str) => {
                    // Find all numbers in the string
                    const numbers = str.match(/\d+/g);
                    if (!numbers || numbers.length === 0) return NaN;
                    
                    // If there's an arrow (->), use the number after it (destination bed)
                    if (str.includes('->') && numbers.length >= 2) {
                        return parseFloat(numbers[numbers.length - 1]);
                    }
                    
                    // Otherwise use the highest number found
                    return Math.max(...numbers.map(n => parseFloat(n)));
                };
                
                const aNum = extractSortNumber(aVal);
                const bNum = extractSortNumber(bVal);
                
                // If both are valid numbers, compare numerically
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    if (sortBy === 'bed-asc') {
                        return aNum - bNum;
                    } else if (sortBy === 'bed-desc') {
                        return bNum - aNum;
                    }
                }
                
                // Handle non-numeric values - sort them alphabetically
                if (isNaN(aNum) && isNaN(bNum)) {
                    return sortBy === 'bed-asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                // Numbers come before non-numbers
                if (isNaN(aNum)) return 1;
                if (isNaN(bNum)) return -1;
                return 0;
            });
        }
        
        console.log(`Filtered ${filteredRows.length} rows from ${data.length - 1} total`);
        
        if (filterStaff && filteredRows.length === 0) {
            console.warn('‚ö†Ô∏è Staff filter returned 0 results! Check if staff values match exactly.');
        }
        
        // Return array with header and filtered rows (maintaining original indices)
        return {header, filteredRows};
    }
    
    // Update results count display
    function updateResultsCount(shown, total) {
        const resultsCount = document.getElementById('resultsCount');
        if (shown === total) {
            resultsCount.textContent = `‡πÅ‡∏™‡∏î‡∏á ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        } else {
            resultsCount.textContent = `‡πÅ‡∏™‡∏î‡∏á ${shown} ‡∏à‡∏≤‡∏Å ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        }
    }
    
    // Apply filters button handler
    window.applyFilters = () => {
        console.log('üîç Apply Filters clicked');
        console.log('Current view:', currentView, 'Current sheet:', currentSheet);
        if (currentView === 'card' && currentSheet) {
            renderCards(currentSheet, true);
        } else {
            console.warn('Cannot apply filters: wrong view or no sheet selected');
        }
    };
    
    // Clear filters button handler
    window.clearFilters = () => {
        document.getElementById('filterWard').value = '';
        document.getElementById('filterStaff').value = '';
        document.getElementById('filterStatus').value = '';
        document.getElementById('sortBy').value = '';
        
        if (currentView === 'card' && currentSheet) {
            renderCards(currentSheet, true);
        }
    };

    // Delete row function
    window.deleteRow = async (rowIndex) => {
        if (!currentSheet) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet ‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        // Confirm deletion
        const confirmed = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ?');
        if (!confirmed) return;

        try {
            // 1. Remove from Firebase
            await set(ref(db, `sheets/${currentSheet}/${rowIndex}`), null);
            console.log('‚úÖ Row deleted from Firebase:', rowIndex);

            // 2. Send delete request to Google Sheets in background
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                redirect: 'follow',
                body: JSON.stringify({
                    action: 'deleteRow',
                    sheetName: currentSheet,
                    rowIndex: rowIndex
                })
            }).then(response => {
                if (response.ok) {
                    console.log('‚úÖ Row deleted from Google Sheets');
                } else {
                    console.error('Failed to delete from Google Sheets');
                }
            }).catch(error => {
                console.error('Google Sheets delete error:', error);
            });

            // 3. Refresh view immediately
            if (currentView === 'card') {
                renderCards(currentSheet, true);
            } else {
                renderTable(currentSheet);
            }
        } catch (error) {
            console.error('Error deleting row:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        }
    };

    // Modal functions
    window.openAddPatientModal = () => {
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('newAdmit').value = today;
        
        // Update queue display
        updateQueueDisplay();
        
        // Auto-select next in queue
        const nextStaff = getNextInQueue();
        document.getElementById('newStaff').value = nextStaff;
        
        // Show modal
        document.getElementById('addPatientModal').classList.add('show');
    };

    window.closeAddPatientModal = () => {
        document.getElementById('addPatientModal').classList.remove('show');
        // Clear form
        document.getElementById('newStaff').value = '';
        document.getElementById('newStaffCustom').value = '';
        document.getElementById('newStaffCustom').style.display = 'none';
        document.getElementById('newStatus').value = '';
        document.getElementById('newWard').value = '';
        document.getElementById('newBed').value = '';
        document.getElementById('newName').value = '';
        document.getElementById('newHN').value = '';
        document.getElementById('newAge').value = '';
        document.getElementById('newDx').value = '';
        document.getElementById('newOperation').value = '';
        document.getElementById('newAdmit').value = '';
        document.getElementById('newTeacher').value = '';
    };

    window.closeAddPatientModalOnOutside = (event) => {
        if (event.target.id === 'addPatientModal') {
            closeAddPatientModal();
        }
    };

    window.submitNewPatient = async () => {
        // Get values
        let staff = document.getElementById('newStaff').value.trim();
        // Check if "other" option was selected, use custom name
        if (staff === 'other') {
            staff = document.getElementById('newStaffCustom').value.trim();
        }
        const status = document.getElementById('newStatus').value.trim();
        const ward = document.getElementById('newWard').value.trim();
        const bed = document.getElementById('newBed').value.trim();
        const name = document.getElementById('newName').value.trim();
        const hn = document.getElementById('newHN').value.trim();
        const age = document.getElementById('newAge').value.trim();
        const dx = document.getElementById('newDx').value.trim();
        const operation = document.getElementById('newOperation').value.trim();
        const admit = document.getElementById('newAdmit').value.trim();
        const teacher = document.getElementById('newTeacher').value.trim();

        // Check if sheet is selected
        if (!currentSheet) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet ‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }

        // Get current data to find max row and column mapping
        const sheetData = allData[currentSheet];
        if (!sheetData) {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sheet');
            return;
        }

        // Get headers to map field names to column indices
        const headers = sheetData[0] || [];
        let staffColIdx = -1;
        let bedColIdx = -1;
        let nameColIdx = -1;
        
        headers.forEach((header, colIdx) => {
            const headerLower = String(header).toLowerCase();
            if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) staffColIdx = colIdx;
            else if (headerLower.includes('‡πÄ‡∏ï‡∏µ‡∏¢‡∏á') || headerLower.includes('bed')) bedColIdx = colIdx;
            else if (headerLower.includes('‡∏ä‡∏∑‡πà‡∏≠') || headerLower.includes('name')) nameColIdx = colIdx;
        });
        
        // Check if this staff has a placeholder row (staff name filled, but bed/name empty)
        let placeholderRowIndex = null;
        const skippedSlots = getSkippedSlots();
        if (skippedSlots.includes(staff)) {
            // Search for placeholder row
            for (let rowIdx = 1; rowIdx <= Object.keys(sheetData).length; rowIdx++) {
                const row = sheetData[rowIdx];
                if (row && Array.isArray(row)) {
                    const rowStaff = staffColIdx >= 0 ? String(row[staffColIdx] || '').trim() : '';
                    const rowBed = bedColIdx >= 0 ? String(row[bedColIdx] || '').trim() : '';
                    const rowName = nameColIdx >= 0 ? String(row[nameColIdx] || '').trim() : '';
                    
                    // Placeholder: has staff name but no bed or patient name
                    if (rowStaff === staff && !rowBed && !rowName) {
                        placeholderRowIndex = rowIdx;
                        console.log('‚úÖ Found placeholder row for', staff, 'at row', rowIdx);
                        break;
                    }
                }
            }
        }
        
        let newRowIndex;
        if (placeholderRowIndex !== null) {
            // Update existing placeholder row
            newRowIndex = placeholderRowIndex;
            console.log('Updating placeholder row:', newRowIndex);
        } else {
            // Find last CONTINUOUSLY numbered row (ignoring gaps)
            const rowKeys = Object.keys(sheetData).map(k => parseInt(k)).filter(n => !isNaN(n)).sort((a, b) => a - b);
            
            console.log('Row keys in Firebase:', rowKeys);
            
            let lastContinuousRow = 0; // Start with header row
            
            // Find the last row in a continuous sequence starting from 0
            for (let i = 0; i < rowKeys.length; i++) {
                if (rowKeys[i] === i) {
                    // This row is part of the continuous sequence
                    lastContinuousRow = i;
                } else {
                    // Found a gap - stop here
                    console.log('Gap found at index', i, ', expected row', i, 'but found', rowKeys[i]);
                    break;
                }
            }
            
            newRowIndex = lastContinuousRow + 1;
            console.log('Last continuous row:', lastContinuousRow);
            console.log('Will add new patient at row:', newRowIndex);
        }

        // Create new row data array based on headers
        const newRowData = new Array(headers.length).fill('');

        // Map form values to columns based on header names
        headers.forEach((header, colIdx) => {
            const headerLower = String(header).toLowerCase();
            if (headerLower.includes('‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö')) newRowData[colIdx] = staff;
            else if (headerLower.includes('status')) newRowData[colIdx] = status;
            else if (headerLower.includes('‡∏ß‡∏≠‡∏£‡πå‡∏î') || headerLower.includes('ward')) newRowData[colIdx] = ward;
            else if (headerLower.includes('‡πÄ‡∏ï‡∏µ‡∏¢‡∏á') || headerLower.includes('bed')) newRowData[colIdx] = bed;
            else if (headerLower.includes('‡∏ä‡∏∑‡πà‡∏≠') || headerLower.includes('name')) newRowData[colIdx] = name;
            else if (headerLower.includes('hn')) newRowData[colIdx] = hn;
            else if (headerLower.includes('‡∏≠‡∏≤‡∏¢‡∏∏') || headerLower.includes('age')) newRowData[colIdx] = age;
            else if (headerLower.includes('dx') || headerLower.includes('diagnosis')) newRowData[colIdx] = dx;
            else if (headerLower.includes('operation') && !headerLower.includes('post')) newRowData[colIdx] = operation;
            else if (headerLower.includes('admit')) newRowData[colIdx] = admit;
            else if (headerLower.includes('‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå') || headerLower.includes('teacher')) newRowData[colIdx] = teacher;
        });

        console.log('Adding new patient at row:', newRowIndex);
        console.log('New row data:', newRowData);

        try {
            // 1. Update Firebase (instant)
            await set(ref(db, `sheets/${currentSheet}/${newRowIndex}`), newRowData);
            
            console.log('‚úÖ Patient added to Firebase');
            
            // Queue will auto-calculate from new data, just update display
            updateQueueDisplay();
            
            closeAddPatientModal();
            
            // Refresh card view immediately
            if (currentView === 'card') {
                renderCards(currentSheet, true);
            }
            
            // 2. Send to Google Sheets in background (don't wait)
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                redirect: 'follow',
                body: JSON.stringify({
                    action: 'addRow',
                    sheetName: currentSheet,
                    rowIndex: newRowIndex,
                    rowData: newRowData
                })
            }).then(response => {
                if (response.ok) {
                    console.log('‚úÖ Patient synced to Google Sheets');
                } else {
                    console.error('Failed to sync to Google Sheets');
                }
            }).catch(error => {
                console.error('Google Sheets sync error:', error);
            });
            
        } catch (error) {
            console.error('Error adding patient:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
        }
    };

    // Color Settings Modal functions
    window.openColorSettings = () => {
        // Update previews with current colors
        updateColorPreviews();
        // Update default view display
        const defaultView = localStorage.getItem('default_view') || 'table';
        document.getElementById('currentDefaultView').textContent = defaultView === 'table' ? 'üìä Table View' : 'üìã Card View';
        document.getElementById('colorSettingsModal').classList.add('show');
    };

    window.closeColorSettingsModal = () => {
        document.getElementById('colorSettingsModal').classList.remove('show');
    };

    window.closeColorSettingsModalOnOutside = (event) => {
        if (event.target.id === 'colorSettingsModal') {
            closeColorSettingsModal();
        }
    };

    const colorMap = {
        'pink': 'linear-gradient(135deg, #ff69b4 0%, #ff1493 100%)',     // Hot Pink
        'yellow': 'linear-gradient(135deg, #ffd700 0%, #ffb800 100%)',   // Gold
        'blue': 'linear-gradient(135deg, #00bfff 0%, #1e90ff 100%)',     // Deep Sky Blue
        'green': 'linear-gradient(135deg, #66cdaa 0%, #3cb371 100%)'     // Medium Aquamarine
    };

    window.pickColor = (staffName, colorName) => {
        const color = colorMap[colorName];
        if (!color) return;

        // Save to localStorage using existing saveStaffColor function
        saveStaffColor(staffName, color);

        // Update preview
        updateColorPreviews();

        // Refresh the current view to apply new colors
        if (currentView === 'card' && currentSheet) {
            renderCards(currentSheet, true);
        } else if (currentSheet) {
            renderTable(currentSheet);
        }
    };

    window.resetColors = () => {
        // Clear localStorage and reload default colors
        localStorage.removeItem('staff_colors');
        
        // Reload staffColors with defaults
        staffColors = {...defaultStaffColors};
        
        // Update previews
        updateColorPreviews();

        // Refresh view
        if (currentView === 'card' && currentSheet) {
            renderCards(currentSheet, true);
        } else if (currentSheet) {
            renderTable(currentSheet);
        }
    };

    function updateColorPreviews() {
        document.getElementById('colorPreviewNat').style.background = getStaffColor('‡∏ô‡∏±‡∏ó');
        document.getElementById('colorPreviewEiong').style.background = getStaffColor('‡πÄ‡∏≠‡∏¥‡∏á');
        document.getElementById('colorPreviewAi').style.background = getStaffColor('‡∏≠‡∏≤‡∏¢');
    }

    // Toggle card expanded details view
    window.toggleCardExpand = (rowIndex) => {
        const expandedSection = document.getElementById(`expanded-${rowIndex}`);
        const expandButton = document.querySelector(`#card-${rowIndex} .btn-expand-card`);
        
        if (expandedSection.style.display === 'none') {
            expandedSection.style.display = 'block';
            if (expandButton) expandButton.textContent = 'üîº';
        } else {
            expandedSection.style.display = 'none';
            if (expandButton) expandButton.textContent = 'üìã';
        }
    };

    // Handle staff dropdown in add patient modal
    document.addEventListener('DOMContentLoaded', () => {
        const staffSelect = document.getElementById('newStaff');
        const staffCustomInput = document.getElementById('newStaffCustom');
        
        if (staffSelect && staffCustomInput) {
            staffSelect.addEventListener('change', function() {
                if (this.value === 'other') {
                    staffCustomInput.style.display = 'block';
                    staffCustomInput.focus();
                } else {
                    staffCustomInput.style.display = 'none';
                    staffCustomInput.value = '';
                }
            });
        }
    });

// Auto-resize input fields based on content
window.autoResizeInput = (input) => {
    if (input.type === 'date') return; // Don't resize date inputs
    
    const minSize = 6;
    const maxSize = 50;
    const contentLength = input.value.length || 1;
    // Add generous buffer of 6 chars to prevent cutoff when typing
    const newSize = Math.min(maxSize, Math.max(minSize, contentLength + 6));
    
    input.setAttribute('size', newSize);
    
    // Also set inline width for extra safety
    const charWidth = 8; // approximate pixels per character
    input.style.minWidth = `${newSize * charWidth}px`;
};

window.updateData = (r, c, val) => {
    // 1. Update Firebase
    update(ref(db, `sheets/${currentSheet}/${r}`), { [c]: val });

    // 2. Send instantly to Google Sheets!
    fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
        redirect: 'follow', // <-- ADD THIS LINE!
        body: JSON.stringify({
            sheetName: currentSheet,
            row: r,
            col: c,
            val: val
        })
    }).catch(err => console.error("Google Sheets update failed", err));
};
// 1. Create a variable to remember what cell we are currently in
    let activeCell = null; 

window.setFocus = (r, c) => {
        activeCell = { r, c, sheet: currentSheet }; 
        
        // 1. Tell Firebase
        set(ref(db, `presence/${myUid}`), { 
            sheet: currentSheet, row: r, col: c, name: myName 
        });

        // 2. Tell Google Sheets (Send the user's unique color!)
        fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
            redirect: 'follow',
            body: JSON.stringify({ 
                action: 'focus', 
                sheetName: currentSheet, 
                row: r, 
                col: c, 
                name: myName, 
                color: myColor // <-- ADDED THIS!
            })
        }).catch(err => console.error("Sheets focus update failed", err));
    };

    window.removeFocus = (r, c) => { 
        activeCell = null; // Forget the cell, we safely clicked away
        
        // 1. Tell Firebase to remove the red box
        set(ref(db, `presence/${myUid}`), null);

        // 2. Tell Google Sheets to remove the Pink color and Note (with retry)
        const clearIndicator = () => {
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                redirect: 'follow',
                body: JSON.stringify({ action: 'blur', sheetName: currentSheet, row: r, col: c })
            }).catch(err => {
                console.error("Sheets blur update failed, retrying...", err);
                // Retry once after a short delay
                setTimeout(() => {
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        redirect: 'follow',
                        body: JSON.stringify({ action: 'blur', sheetName: currentSheet, row: r, col: c })
                    }).catch(e => console.error("Retry failed", e));
                }, 500);
            });
        };
        clearIndicator();
    };

    // 3. Cleanup when user switches tabs or minimizes browser
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && activeCell) {
            // User switched to another tab - clear the indicator
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                keepalive: true,
                body: JSON.stringify({ action: 'blur', sheetName: activeCell.sheet, row: activeCell.r, col: activeCell.c })
            });
        }
    });

    // 4. Emergency cleanup if they close the browser tab!
    window.addEventListener('beforeunload', () => {
        if (activeCell) {
            // Instantly remove Firebase presence
            set(ref(db, `presence/${myUid}`), null);
            
            // Send emergency signal to Google Sheets
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                keepalive: true, // <-- CRITICAL: Forces request to finish while tab closes
                body: JSON.stringify({ action: 'blur', sheetName: activeCell.sheet, row: activeCell.r, col: activeCell.c })
            });
        }
    });
</script>


</body>
</html>
